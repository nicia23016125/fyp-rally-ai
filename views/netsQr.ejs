<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <script src="https://unpkg.com/event-source-polyfill"></script> <!-- Include EventSource Polyfill -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <%- include ('partials/navbar.ejs') %>
        <div class="row fs-1 text-center">
            <p>Your order total is: <%=total%>
            </p>
        </div>
        <div class="text-center">
            <h1>Scan the QR Code</h1>
            <p id="status">Scan with your bank simulator app to complete payment</p>
            <img src="<%= qrCodeUrl %>" alt="QR Code" />
            <p id="timer">Time remaining: 3:00</p> <!-- Countdown Timer -->
            <img height="auto" width="15%" src="./images/netsQrInfo.png" /><br />
            <a href="/cart"><button type="button" class="btn btn-danger">Cancel</button></a>
        </div>

        <script>
            let s2sNetsTxnStatus; // Declare a variable to hold the EventSource instance

            if (s2sNetsTxnStatus) {
                s2sNetsTxnStatus.close();
            }

            const txnRetrievalRef = "<%= txnRetrievalRef %>"; // Transaction reference
            const url = `<%= webhookUrl %>?txn_retrieval_ref=${txnRetrievalRef}`; // Webhook URL
            const headers = {
                "api-key": "<%= apiKey %>",
                "project-id": "<%= projectId %>",
            };

            console.log("Webhook URL:", url);

            // Initialize EventSourcePolyfill with headers
            s2sNetsTxnStatus = new EventSourcePolyfill(url, {
                headers: headers,
                heartbeatTimeout: 150000,
            });

            s2sNetsTxnStatus.addEventListener("message", (event) => {
                const data = JSON.parse(event.data);
                console.log("Event Data:", data);

                if (data.message === "QR code scanned") {
                    if (s2sNetsTxnStatus) {
                        s2sNetsTxnStatus.close();
                    }

                    window.location.href = "/nets-qr/success";
                } else if (data.message === "Timeout") {
                    if (s2sNetsTxnStatus) {
                        s2sNetsTxnStatus.close();
                    }

                    alert("Transaction timed out. Redirecting...");
                    window.location.href = "/nets-qr/fail"; // Redirect to fail page
                }
            });

            console.log("Initialized EventSourcePolyfill");

            // Countdown Timer Logic
            const timerElement = document.getElementById("timer");
            const countdownDuration = 180; // 3 minutes in seconds
            let remainingTime = countdownDuration;

            const updateTimer = () => {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;
                remainingTime--;

                if (remainingTime < 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Transaction timed out.";

                    if (s2sNetsTxnStatus) {
                        s2sNetsTxnStatus.close();
                    }
                    window.location.href = "/nets-qr/fail"; // Redirect to fail page
                }
            };

            // Start the timer
            const timerInterval = setInterval(updateTimer, 1000);
            updateTimer(); // Initial call to set the timer immediately
        </script>
</body>

</html>