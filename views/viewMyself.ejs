<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <title>Rally AI - My Profile</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('/images/k.jpg') no-repeat center center fixed;
      background-size: cover;
      color: white;
    }

    /* Main Container */
    .profile-container {
      max-width: 600px;
      background-color: rgba(255, 255, 255, 0.95);
      color: black;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    }

    .profile-image {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #e6eefb;
    }

    .edit-btn {
      background-color: #28a745;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: bold;
      display: inline-block;
      transition: 0.3s;
    }

    .edit-btn:hover { background-color: #218838; color: white; }

    .sub-card {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        border-left: 5px solid #0d6efd;
    }

    /* --- GALLERY STYLES --- */
    .video-gallery-container {
      max-width: 1000px;
      margin-top: 30px;
      background-color: rgba(255, 255, 255, 0.95);
      color: black;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
    }
    
    .media-card {
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #ddd;
        transition: transform 0.2s;
        background: #fff;
    }
    .media-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    
    .video-wrapper video { width: 100%; height: 200px; object-fit: cover; background: #000; }
    
    .image-wrapper { 
        height: 200px; 
        overflow: hidden; 
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .image-wrapper img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
    }

    .media-meta { padding: 15px; }
    .media-prompt { font-size: 0.9rem; color: #555; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.7em; }
    .media-date { font-size: 0.75rem; color: #999; margin-top: 5px; display: block; }
    .download-link { font-size: 0.85rem; text-decoration: none; color: #0d6efd; font-weight: bold; }

  </style>
</head>
<body>

  <%- include ('partials/navbar.ejs') %>

  <div class="container d-flex flex-column align-items-center py-5">
    
    <div class="profile-container text-center w-100 mb-4">
      <h2 class="mb-4">My Profile</h2>
      <img src="/images/<%= userProfile.userImage %>" class="profile-image mb-3" alt="Profile Image">
      <h4><%= userProfile.username %></h4>
      <p class="text-muted mb-1"><%= userProfile.userEmail %></p>
      <span class="badge bg-secondary mb-3"><%= userProfile.userRole %></span>
      
      <div>
          <a href="/editMyself" class="edit-btn btn-sm">Edit Profile</a>
      </div>

      <hr class="my-4">

      <h5 class="text-start"><i class="fas fa-crown text-warning me-2"></i>Current Plan</h5>

      <% if (subscription) { %>
        <div class="sub-card text-start">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0 fw-bold text-primary"><%= subscription.plan_name %></h4>
                <span class="badge bg-success">Active</span>
            </div>
            
            <div class="row mt-3">
                <div class="col-6">
                    <small class="text-muted">Credits</small>
                    <div class="fw-bold"><%= subscription.credit %></div>
                </div>
                <div class="col-6">
                    <small class="text-muted">Expires On</small>
                    <div class="fw-bold"><%= new Date(subscription.end_date).toLocaleDateString() %></div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <a href="/subscription/<%= subscription.subscription_id %>" class="btn btn-outline-primary btn-sm rounded-pill">View Details</a>
            </div>
        </div>
      <% } else { %>
        <div class="alert alert-light border text-start mt-3">
            <p class="mb-2 text-muted small">You do not have an active subscription.</p>
            <a href="/subscriptions" class="btn btn-dark btn-sm w-100">Upgrade Plan</a>
        </div>
      <% } %>
    </div>

    <div class="video-gallery-container w-100">
        <h4 class="mb-4 text-start"><i class="fas fa-film text-danger me-2"></i>My Generated Videos</h4>
        
        <% if (videos && videos.length > 0) { %>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <% videos.forEach(video => { %>
                    <div class="col">
                        <div class="media-card">
                            <div class="video-wrapper">
                                <video controls preload="metadata">
                                    <source src="<%= video.file_path %>" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                            <div class="media-meta text-start">
                                <p class="media-prompt" title="<%= video.prompt %>">"<%= video.prompt %>"</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="media-date"><i class="far fa-calendar-alt me-1"></i><%= new Date(video.created_at).toLocaleDateString() %></span>
                                    
                                    <div class="d-flex align-items-center">
                                        <a href="<%= video.file_path %>" download class="download-link me-3">
                                            <i class="fas fa-download me-1"></i> Save
                                        </a>

                                        <a href="javascript:void(0)" 
                                           onclick="handleSaveToDrive('<%= video.file_path %>', '<%= video.video_id %>', 'video', this)" 
                                           class="text-success text-decoration-none fw-bold" 
                                           style="font-size: 0.85rem; cursor: pointer;">
                                            <i class="fab fa-google-drive me-1"></i> Drive
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                <p class="text-muted">You haven't generated any videos yet.</p>
                <a href="/?openBot=1" class="btn btn-primary">Start Creating Videos</a>
            </div>
        <% } %>
    </div>

    <div class="video-gallery-container w-100 mt-4">
        <h4 class="mb-4 text-start"><i class="fas fa-images text-success me-2"></i>My Generated Images</h4>
        
        <% if (images && images.length > 0) { %>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                <% images.forEach(img => { %>
                    <div class="col">
                        <div class="media-card">
                            <div class="image-wrapper">
                                <% 
                                    let imgSrc = "";
                                    let isBase64 = false;
                                    // Check if it's a URL or Base64 Data
                                    if (img.image_base64 && img.image_base64.startsWith('http')) {
                                        imgSrc = img.image_base64; 
                                    } else {
                                        imgSrc = "data:image/png;base64," + img.image_base64;
                                        isBase64 = true;
                                    }
                                %>
                                <img src="<%= imgSrc %>" alt="Generated AI Image">
                            </div>
                            <div class="media-meta text-start">
                                <p class="media-prompt" title="<%= img.prompt %>">"<%= img.prompt %>"</p>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span class="media-date"><i class="far fa-clock me-1"></i><%= new Date(img.created_at).toLocaleDateString() %></span>
                                    
                                    <div class="d-flex align-items-center">
                                        
                                        <% if (isBase64) { %>
                                            <a href="javascript:void(0)" 
                                               onclick="downloadBase64('<%= imgSrc %>', 'RallyAI_Image_<%= img.id %>.png')" 
                                               class="download-link me-3">
                                                <i class="fas fa-download me-1"></i> Save
                                            </a>
                                        <% } else { %>
                                            <a href="<%= imgSrc %>" download="RallyAI_Image.png" class="download-link me-3">
                                                <i class="fas fa-download me-1"></i> Save
                                            </a>
                                        <% } %>

                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="text-center py-5">
                <i class="fas fa-image fa-3x text-muted mb-3"></i>
                <p class="text-muted">You haven't generated any images yet.</p>
                <a href="/?openBot=1" class="btn btn-success">Create Storyboard</a>
            </div>
        <% } %>
    </div>

  </div>

  <script>
    // âœ… HELPER: SAFE BASE64 DOWNLOAD (Prevents 'about:blank#blocked')
    function downloadBase64(dataUrl, fileName) {
        fetch(dataUrl)
            .then(res => res.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(err => {
                console.error("Download failed:", err);
                alert("Could not download image. Try right-clicking and 'Save Image As'.");
            });
    }

    // âœ… GOOGLE DRIVE UPLOAD LOGIC
    async function handleSaveToDrive(fileUrl, uniqueId, type, btnElement) {
        
        // 1. Check if Google Tokens exist
        const isGoogleLoggedIn = <%= (typeof tokens !== 'undefined' && tokens) ? 'true' : 'false' %>; 

        if (!isGoogleLoggedIn) {
            console.log("Not connected to Google. Redirecting to Auth...");
            const state = encodeURIComponent(JSON.stringify({ 
                action: 'save_to_drive', 
                fileUrl: fileUrl,
                returnTo: '/viewMyself' 
            }));
            window.location.href = `/auth/google?state=${state}`;
            return;
        }

        // 2. Determine Filename
        let fileName = "";
        if (type === 'video') {
            fileName = `RallyAI_Video_${uniqueId}.mp4`;
        } else {
            fileName = `RallyAI_Image_${uniqueId}.png`;
        }

        // 3. UI Feedback
        const originalContent = btnElement.innerHTML;
        btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        btnElement.style.pointerEvents = 'none';
        
        try {
            const response = await fetch('/drive/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    fileUrl: fileUrl, 
                    fileName: fileName 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert("âœ… Saved to Google Drive!");
                btnElement.innerHTML = '<i class="fas fa-check"></i> Saved';
            } else {
                throw new Error(result.error || "Unknown Error");
            }
        } catch (err) {
            console.error(err);
            alert("âŒ Upload Failed: " + err.message);
            btnElement.innerHTML = originalContent; 
        } finally {
            btnElement.style.pointerEvents = 'auto'; 
        }
    }

    // Auto-save logic
    window.addEventListener('load', () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('autosave') === 'true') {
            const fileUrl = urlParams.get('fileUrl');
            window.history.replaceState({}, document.title, window.location.pathname);
            alert("ðŸ”„ Completing your Save to Drive...");
            
            // Auto-save handles videos by default
            fetch('/drive/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    fileUrl: fileUrl, 
                    fileName: `RallyAI_AutoSaved.mp4` 
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) alert("âœ… Auto-save successful!");
                else alert("âŒ Auto-save failed: " + data.error);
            })
            .catch(err => console.error(err));
        }
    });
  </script>

</body>
</html>